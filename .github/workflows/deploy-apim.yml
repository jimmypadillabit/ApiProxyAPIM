name: Deploy APi Comercios to APIM

on:
  push:
    branches: [ main ]

env:
  AZ_RG: rg-demo-provefarma-apim
  APIM_NAME: apim-provefarma-demo
  SUBSCRIPTION_ID: a407594f-18e1-4ed7-b941-507c946bb6b3
  API_ID: api-comercios
  PRODUCT_ID: comercios

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Azure CLI login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - name: Pre-check for duplicate API path
        run: |
          echo "Checking for existing APIs with path 'api-comercios'..."
          existing=$(az apim api list --resource-group $AZ_RG --service-name $APIM_NAME --query "[?properties.path=='api-comercios']" -o tsv)
          if [ -n "$existing" ]; then
            echo "Found existing API(s) with path 'api-comercios'. Please verify before proceeding." >&2
            az apim api list --resource-group $AZ_RG --service-name $APIM_NAME --query "[].{id:id,name:properties.displayName,path:properties.path}" -o table
            exit 1
          fi
      - name: Import API into APIM
        run: |
          az apim api import --resource-group $AZ_RG --service-name $APIM_NAME --path api-comercios --api-id $API_ID --specification-format OpenApi --specification-path apim/APiComercios/openapi.yaml --service-url http://4.157.52.221/api
      - name: Ensure product exists (comercios)
        run: |
          set -e
          if az apim product show --resource-group $AZ_RG --service-name $APIM_NAME --product-id $PRODUCT_ID >/dev/null 2>&1; then
            echo "Product $PRODUCT_ID already exists"
          else
            echo "Creating product $PRODUCT_ID"
            az apim product create --resource-group $AZ_RG --service-name $APIM_NAME --product-id $PRODUCT_ID --display-name "Comercios" --approval-required false --subscription-required false
          fi
      - name: Add API to product comercios
        run: |
          az apim product api add --resource-group $AZ_RG --service-name $APIM_NAME --product-id $PRODUCT_ID --api-id $API_ID || true
      - name: Apply policy to API
        run: |
          POLICY_XML=$(sed -e ':a;N;$!ba;s/\n/\\n/g' apim/APiComercios/policy.xml | sed 's/"/\\"/g')
          BODY="{\"properties\":{\"value\":\"$POLICY_XML\",\"format\":\"rawxml\"}}"
          az rest --method PUT --uri "https://management.azure.com/subscriptions/$SUBSCRIPTION_ID/resourceGroups/$AZ_RG/providers/Microsoft.ApiManagement/service/$APIM_NAME/apis/$API_ID/policy?api-version=2021-08-01" --body "$BODY"
      - name: Quick smoke test
        run: |
          echo "Calling API via gateway to verify (may require subscription key)"
          curl -s -o response.json -w "%{http_code}" "https://apim-provefarma-demo.azure-api.net/api/farmacias/disponibilidad?medicamento=paracetamol&ciudad=quito"
          cat response.json | jq || true
name: Deploy APi Comercios to APIM

on:
  push:
    branches: [ main ]

env:
  AZ_RG: rg-demo-provefarma-apim
  APIM_NAME: apim-provefarma-demo
  SUBSCRIPTION_ID: a407594f-18e1-4ed7-b941-507c946bb6b3
  API_BASE_ID: api-comercios
  PRODUCT_ID: comercios
  VERSION_SET_ID: comercios-version-set
  APPLY_POLICY: "false"
  APPLY_POLICY: "false"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Azure CLI login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - name: Detect API version from OpenAPI
        id: detect
        run: |
          echo "Detecting version from openapi.yaml..."
          if ! command -v yq >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y jq yq
          fi
          VERSION=$(yq e '.info.version' apim/APiComercios/openapi.yaml)
          echo "OpenAPI version detected: $VERSION"
          MAJOR=$(echo $VERSION | cut -d '.' -f1)
          echo "Major version: $MAJOR"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "MAJOR=$MAJOR" >> $GITHUB_OUTPUT
      - name: Detect API version from OpenAPI (single pass)
        id: detect
        run: |
          echo "Detecting version from openapi.yaml..."
          if ! command -v yq >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y jq yq
          fi
          VERSION=$(yq e '.info.version' apim/APiComercios/openapi.yaml)
          echo "OpenAPI version detected: $VERSION"
          MAJOR=$(echo $VERSION | cut -d '.' -f1)
          echo "Major version: $MAJOR"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "MAJOR=$MAJOR" >> $GITHUB_OUTPUT
      - name: Set API variables
        id: set-vars
        run: |
          VERSION=${{ steps.detect.outputs.VERSION }}
          MAJOR=${{ steps.detect.outputs.MAJOR }}
          API_ID="${{ env.API_BASE_ID }}-v${MAJOR}"
          API_PATH="${{ env.API_BASE_ID }}/v${MAJOR}"
          echo "API_ID=$API_ID" >> $GITHUB_OUTPUT
          echo "API_PATH=$API_PATH" >> $GITHUB_OUTPUT
      - name: Pre-check for duplicate API path
        run: |
          API_PATH="${{ env.API_BASE_ID }}/v${{ steps.detect.outputs.MAJOR }}"
          echo "Checking for existing API with path '$API_PATH'..."
          existing=$(az apim api list --resource-group $AZ_RG --service-name $APIM_NAME --query "[?properties.path=='$API_PATH']" -o tsv || echo "")
          if [ -n "$existing" ]; then
            echo "API with path $API_PATH already exists — the import will update this API."
          else
            echo "No API with path $API_PATH found — creating a new API."
          fi

      - name: Ensure version set exists
        run: |
          VS_EXISTS=$(az apim api versionset show --resource-group $AZ_RG --service-name $APIM_NAME --version-set-id $VERSION_SET_ID --query "id" -o tsv || echo "")
          if [ -z "$VS_EXISTS" ]; then
            echo "Creating version set: $VERSION_SET_ID"
            az apim api versionset create --resource-group $AZ_RG --service-name $APIM_NAME --display-name "Comercios API versions" --versioning-scheme Segment --version-set-id $VERSION_SET_ID
          else
            echo "Version set exists: $VS_EXISTS"
          fi
          # Wait for the version set to be available (some Azure resources take a moment)
          for i in 1 2 3 4 5; do
            VS_EXISTS=$(az apim api versionset show --resource-group $AZ_RG --service-name $APIM_NAME --version-set-id $VERSION_SET_ID --query "id" -o tsv || echo "")
            if [ -n "$VS_EXISTS" ]; then
              echo "Version set is available: $VS_EXISTS"
              break
            fi
            echo "Version set not yet available, waiting... (attempt $i)"
            sleep 3
          done
      - name: Import API into APIM
        run: |
          echo "Importing API into APIM with version set"
          VERSION=${{ steps.detect.outputs.VERSION }}
          MAJOR=${{ steps.detect.outputs.MAJOR }}
          API_ID="${{ env.API_BASE_ID }}-v${MAJOR}"
          API_PATH="${{ env.API_BASE_ID }}/v${MAJOR}"
          az apim api import --resource-group $AZ_RG --service-name $APIM_NAME --path $API_PATH --api-id $API_ID --specification-format OpenApi --specification-path apim/APiComercios/openapi.yaml --service-url http://4.157.52.221/api --api-version $VERSION --api-version-set-id $VERSION_SET_ID
      - name: Ensure product exists (comercios)
        run: |
          set -e
          if az apim product show --resource-group $AZ_RG --service-name $APIM_NAME --product-id $PRODUCT_ID >/dev/null 2>&1; then
            echo "Product $PRODUCT_ID already exists"
          else
            echo "Creating product $PRODUCT_ID"
            az apim product create --resource-group $AZ_RG --service-name $APIM_NAME --product-id $PRODUCT_ID --display-name "Comercios" --approval-required false --subscription-required false
          fi
      - name: Add API to product comercios
        run: |
          API_ID="${{ env.API_BASE_ID }}-v${{ steps.detect.outputs.MAJOR }}"
          az apim product api add --resource-group $AZ_RG --service-name $APIM_NAME --product-id $PRODUCT_ID --api-id $API_ID || true
      - name: Apply policy to API
        if: env.APPLY_POLICY == 'true'
        run: |
          # Build a valid JSON payload safely from the XML file and send as file to az rest
          if ! command -v jq >/dev/null 2>&1; then
            echo "jq is required but not installed. Installing jq..."
            sudo apt-get update && sudo apt-get install -y jq
          fi
          API_ID="${{ env.API_BASE_ID }}-v${{ steps.detect.outputs.MAJOR }}"
          jq -Rs '{value: ., format: "rawxml"}' apim/APiComercios/policy.xml > /tmp/policy_payload.json
          az rest --method PUT --uri "https://management.azure.com/subscriptions/$SUBSCRIPTION_ID/resourceGroups/$AZ_RG/providers/Microsoft.ApiManagement/service/$APIM_NAME/apis/$API_ID/policy?api-version=2021-08-01" --body @/tmp/policy_payload.json
      - name: Quick smoke test
        run: |
          echo "Calling API via gateway to verify (may require subscription key)"
          API_PATH="${{ env.API_BASE_ID }}/v${{ steps.detect.outputs.MAJOR }}"
          curl -s -o response.json -w "%{http_code}" "https://$APIM_NAME.azure-api.net/$API_PATH/farmacias/disponibilidad?medicamento=paracetamol&ciudad=quito"
          cat response.json | jq || true
